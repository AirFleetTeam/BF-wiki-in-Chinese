# LED灯带

Betaflight支持使用可寻址LED灯带。可寻址LED灯带允许灯带中的每个LED被编程为单独的颜色。这比普通的RGB灯带要先进得多，而RGB灯带中的每个LED都将显示相同的颜色。

### LED灯带模式

LED灯带具有三个子功能：STATUS，RACE和BEACON。分别使用三个独立的与名称对应的LED配置文件来配置。可以从CLI、OSD的LED菜单或拨杆辅助通道（遥控器）更改所选的配置文件。请注意，使用遥控器的辅助通道做出的更改会覆盖其他方式所选择的LED灯条配置文件。

#### STATUS模式

该模式用于显示以下所有信息，即警告、指示、左右扫描等。

可寻址的LED的LED灯条可用于显示来自飞控的信息，当前支持一下功能：

* 最高支持32个LED。（可以支持更多的LED，只是需要进一步开发）
* 灯光指示当前Pitch/Roll摇杆位置
* 方向/指向灯
* 某一飞行模式下使用特定的灯光配色方案
* 电池低电压警告
* 辅助通道控制LED开/关
* GPS状态信息
* RSSI强度显示
* 电池电量显示

#### RACE模式

该模式将会把所有LED灯带都调成相同颜色，以用于竞赛。例如，根据灯带颜色来辨认飞机。LED灯带所有灯珠颜色都将保持相同且不再变化，不会显示其他信息。

#### BEACON模式

该模式用于搜寻坠机的飞机，它每秒使所有LED变白一次。同样，在此模式下，LED灯带上不会显示其他信息。

LED灯带配置文件设置





### 支持的硬件

当前仅支持有32个WS2811/WS2812灯珠的LED灯带。若灯珠数量超过32个，则仅会使用前32个LED灯珠。

需要使用800KHz信号和精准的时序才能控制WS2812灯珠，因此需要为LED焊盘配置专用的硬件计时器。

注意：并非所有WS2812芯片都使用相同的时序，有些批次使用的时序并不一样。

如果确实有需要的话，可由用户自定义所需的时序。

#### WS2811和WS2812

WS2811是一个连接到RGB灯珠上的LED驱动芯片。可以向其输入红-绿-蓝各8位的数据信号。（红、绿、蓝各8位）

WS2812则是5050（或3535）灯珠中集成LED驱动芯片，而不是两者各自作为独立设备。可以向其输入绿-红-蓝各8位的数据信号。

因此，根据LED灯带使用的芯片不同，需要使用红-绿-蓝或绿-红-蓝数据编码。可以通过下列CLI来修改颜色数据编码序列

`set ledstrip_grb_rgb = RGB`

或

`set ledstrip_grb_rgb = GRB`

然后只需将LED设置为绿色，即可确认设置是否正确。如果LED呈红色，则设置错误。

### 连线

WS2812灯带通常需要一根数据线、5V供电线和GND地线。

WS2812 LED处于全亮状态会消耗大量电流。建议检查电流消耗情况，以确保您的电源足以拖动负载。若多旋翼飞行器的电调均具有BEC，可以尝试用不同的BEC分别为飞控板和LED灯带供电。例如，ESC1/BEC1-&gt;FC，ESC2/BEC2-&gt;LED灯带。也可以一侧灯带使用一个BEC供电，另一侧使用另一个BEC供电。只需要确保所有的BEC与LED均接有效地即可。

如果您的LED有的亮有的不亮、闪烁或显示错误的颜色，那么可以尝试将输入电压降至4.7v以下。例如，可以在5v供电线上串联二极管。这些问题都是由于数据信号与电源信号之间的电压差而引起的。WS2811要求数据信号（Din）高低电平分别0.7xVin以上，0.3xVin以下，才能完成高低信号的辨识。飞控板上的LED焊盘输出电平为0-3.3V，所以供电电压应该为4.7V（3.3V/0.7 = 4.71V）。部分输入信号容受区间较宽的LED则可忽略此要求。

### 配置

可以在配置程序内的图形界面内配置LED灯带的功能。

使用“LED灯带”选项卡来配置LED。首先设置LED的布局，以告知飞控有多少个LED可用，也便于稍后对LED进行可视化配置。

有关如何使用配置程序来逐步配置LED的功能，请参阅[这里](http://blog.oscarliang.net/setup-rgb-led-cleanflight/)。该指南由Oscar Liang与2015年初发布，在您阅读本文时部分内容可能已不再具有实用意义。

通过CLI命令启用LED灯带功能：

```text
feature LED_STRIP
```

如果您启用该功能，但在重启之后该功能仍被关闭，那么您需要检查您的设置是否与LED灯带功能冲突，如上文所示。

使用CLI命令led来配置LED。

led命令有两个参数：从0开始的LED编号、一个控制序列。该序列包含一个坐标、方向标志、模式标志和一种颜色。

每个LED的控制序列可以使用如下模板进行配置：

```text
x,y:ddd:mmm:cc
```

x和y是16x16的网格坐标，从零计数，左上角为0,0，右下角为15,15。

ddd用于指定朝向。假定网格为上北下南左西右东，飞机头部在北，尾部在南。因为LED可以面向任何方向，因此有多种方向可供选择：

`N`-北 `E`-东 `S`-南 `W`-西 `U`-上 `D`-下

例如，向下45°面向东南方向的LED可以配置为SED。

注意：可以将LED配置为全向，但NESWUD可能没有任何意义。

mmm用于设定LED的模式。

每一个LED都可以设置一个基本功能：

* C-颜色color
* F-飞行模式和转向Flight mode & Orientation
* A-解锁状态Armed state
* R-油门环状态
* G-GPS状态
* S-RSSI强度
* L-电池状态

并且每个LED都可以有叠加功能：

* W-警告Warnings
* I-转向灯Indicator
* T-油门状态Thrust state
* B-闪烁（两次）模式Blink mode
* O-左右扫描模式Larson Scanner
* N-降落指示灯（油门低于50%闪烁）Blink on landing

cc用于设置LED颜色编号（编号从0计数）。

例如：

```text
led 0 0,15:SD:AWI:0
led 1 15,0:ND:AWI:0
led 2 0,0:ND:AWI:0
led 3 0,15:SD:AWI:0
led 4 7,7::c:1
led 5 8,8::C:2
led 6 8,9::B:1
```

要擦除LED并标记LED灯带尾端，请将第二个参数设置为`0,0:::`，如下所示：

```text
led 4 0,0:::
```

最好擦除所有未使用的LED。

模式

警告模式

当发生警告时，此模式仅会闪烁LED。

| 警告 | LED闪烁模式 | 注释 |
| :--- | :--- | :--- |
| 处于无法解锁状态 | 绿灯闪烁 | 在校准期间或当飞行器因倾角过大而无法解锁时出现 |
| 低电量 | 红灯闪烁 | 必须启用电池监视功能。可能会在高油门下因电压下降而暂时触发 |
| 失控保护 | 浅蓝与黄色交替闪烁 | 必须已设置并启用失控保护 |

各种模式将按顺序逐次闪烁显示，因此很容易得知到底启用了哪些警告。

GPS状态

此模式显示GPS状态和已经搜到的卫星数量。

定位未成功/失败=闪烁红色 3D定位成功=闪烁绿色

LED的闪烁次数指示当前已搜到的卫星数量。闪烁x次后将暂停闪烁，并重新开始（闪烁）。

RSSI级别

此模式将使用LED颜色指示RSSI级别。

| 颜色 | RSSI |
| :--- | :--- |
| 绿色 | 100％ |
| 柠檬绿 | 80％ |
| 黄色 | 60％ |
| 橙子 | 40％ |
| 红 | 20％ |
| 深粉红色 | 0％ |

当RSSI低于50%时，LED将缓慢闪烁；低于20%时，LED将快速闪烁。

电池电量

此模式将使用LED颜色指示电池剩余电量。

| 颜色 | 剩余电量 |
| :--- | :--- |
| 绿色 | 100％ |
| 柠檬绿 | 80％ |
| 黄色 | 60％ |
| 橙子 | 40％ |
| 红 | 20％ |
| 深粉红色 | 0％ |

当达到警告电压或临界电压时，LED将缓慢或快速闪烁。注意：此模式需要启用电流传感器。如果您并没有此设备，则可以设置并使用虚拟电流计（请参阅电池章节）。

纯闪烁（Blink）

此模式将使选定的LED闪烁，或从黑色闪烁到当前的设定颜色下。

着陆时闪烁

当油门低于50%且已解锁时，此模式将使选定的LED闪烁，或从黑色闪烁到当前设定颜色下。

左右闪烁（拉森扫描仪，Cylon特效，来自《霹雳游侠》）

该模式复刻了霹雳游侠中机械Cylons和Kitt的“眼睛”特效。此覆盖层动画会使所有激活此功能的LED在某些时刻变暗，并在某些时刻变亮。不论解锁状态如何，动画都不会静止。

飞行模式和方向

此模式显示飞行模式和方向。

当此功能激活时，LED会根据模式、自身所处的网络位置和方向，显示不同的颜色。

LED的优先级：

* 标记为朝上或者朝下的LED
* 标记为面向西或东且在网格的西或东
* 标记为面向北或南且在网格的北或南

也就是说，朝南的LED优先权最低。

目前，LED模式和颜色之间的映射是固定的，无法更改。

